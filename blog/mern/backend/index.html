<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Annotated MERN II: Backend | S. Verona Li≈°kov√°</title>
<meta name="title" content="Annotated MERN II: Backend" />
<meta name="description" content="Annotations for the Express and Mongo/Mongoose part of the repo." />
<meta name="keywords" content="" />


<meta property="og:title" content="Annotated MERN II: Backend" />
<meta property="og:description" content="Annotations for the Express and Mongo/Mongoose part of the repo." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sverona.dev/blog/mern/backend/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-10-02T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-02T00:00:00+00:00" />




<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Annotated MERN II: Backend"/>
<meta name="twitter:description" content="Annotations for the Express and Mongo/Mongoose part of the repo."/>



<meta itemprop="name" content="Annotated MERN II: Backend">
<meta itemprop="description" content="Annotations for the Express and Mongo/Mongoose part of the repo."><meta itemprop="datePublished" content="2021-10-02T00:00:00+00:00" />
<meta itemprop="dateModified" content="2021-10-02T00:00:00+00:00" />
<meta itemprop="wordCount" content="669">
<meta itemprop="keywords" content="" />
<meta name="referrer" content="no-referrer-when-downgrade" />

  
  <link href="https://sverona.dev/fonts/fonts.css" type="text/css" rel="stylesheet" />
  
  
  <link href="https://sverona.dev/sass/style.css" type="text/css" rel="stylesheet" />
  <link href="https://sverona.dev/sass/sidenotes.css" type="text/css" rel="stylesheet" />
  

  <script>
    // @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&dn=gpl-3.0.txt GPL-3.0

    

    document.addEventListener("DOMContentLoaded", () => {
      var els = document.getElementsByClassName("highlight");
      for (var i = 0; i < els.length; i++) {
        if (els[i].title.length) {
          var newNode = document.createElement("code");
          var textNode = document.createTextNode(els[i].title);
          newNode.appendChild(textNode);
          newNode.classList.add("highlight-title");
          var pre = els[i].querySelector('pre');
          pre.appendChild(newNode);
        }
      }
    });
    // @license-end
  </script>

</head>

<body>
  <header id="header"><a href="/" class="title" id="brand">
  <span id="accent"></span>S. Verona Li≈°kov√°
</a>
<nav><ul>

<li><a href="/blog">blog</a></li>

<li><a href="https://github.com/sverona">github</a></li>

<li><a href="/about">about</a></li>

</ul>
</nav>
</header>
  <main><noscript>
  <section style="background-color: #e6e8fa; margin-block: 1rem; padding: 1px 1rem; box-shadow: 2px 2px #000">
    <p>Hello, sentient being who has disabled JavaScript/is using <a href="https://www.gnu.org/software/librejs/index.html">LibreJS</a>!</p>
    <p>This site uses as little JavaScript as I can get away with, but it does require JS to:</p>
<ol>
  <li>render mathematics; for this purpose I use <a href="https://katex.org">KaTeX</a>, which is freely licensed (and partially trans-made! üè≥Ô∏è‚Äçüåà)</li>
  <li>slightly extend Hugo's <a href="https://gohugo.io/content-management/syntax-highlighting/#highlight-shortcode">highlight shortcode</a> to show filenames in code listings. (The actual syntax highlighting is done server-side.)</li>
</ol>
    <p>This site validates under LibreJS as of 6 September 2022. If you find otherwise, please contact me.</p>
  </section>
</noscript>

<header id="front-matter" class="margin-right margin-left">
  <nav>
    <div id="current-section">
      
        <a href="https://sverona.dev/blog/mern/">Annotations for a minimal MERN repo</a>
      
    </div>
    
    <div id="next-prev">
      
      <span>
       
      &twoheadleftarrow; <a href="https://sverona.dev/blog/mern/node/">Annotated MERN I: Node.js</a>
       
      </span>
      <span>
       
      <a href="https://sverona.dev/blog/mern/frontend/">Annotated MERN III: Frontend</a> &twoheadrightarrow;
       
      </span>
    </div>
    
  </nav>
  <div style="text-align: center">
    
    <time datetime='2021-10-02' pubdate>
      October 2, 2021
    </time>
    
    <h1>Annotated MERN II: Backend</h1>
    
    <em id="page-description">Annotations for the Express and Mongo/Mongoose part of the repo.</em>
    
    
  </div>
</div>
</header>

<article>
  
  <div id="toc" class="margin-toggle margin-left">
    <h2>Table of Contents</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#indexjs">index.js</a></li>
    <li><a href="#src">src/</a>
      <ul>
        <li><a href="#srcdbjs">src/db.js</a></li>
        <li><a href="#srcmodelstaskjs">src/models/task.js</a></li>
        <li><a href="#srcroutestasksjs">src/routes/tasks.js</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
  
  <p>This post continues our look at <a href="https://github.com/jmsv">James Vickery</a>&rsquo;s <a href="https://github.com/jmsv/simple-mern">simple-mern</a> repository. Today we&rsquo;ll look at the backend, which is built in Express and Mongo and located under the <code>client/</code> folder.</p>
<h2 id="indexjs">index.js</h2>
<p>This is the root Express server and router. Here are the libraries.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> express = require(<span style="color:#666;font-style:italic">&#39;express&#39;</span>);
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> path = require(<span style="color:#666;font-style:italic">&#39;path&#39;</span>);
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> bodyParser = require(<span style="color:#666;font-style:italic">&#39;body-parser&#39;</span>);
</span></span></code></pre></div><p>First we load the Express server and any routes we may need. There&rsquo;s just the one.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> app = express();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> routeTasks = require(<span style="color:#666;font-style:italic">&#39;./src/routes/tasks&#39;</span>);
</span></span></code></pre></div><p>The next section specifies the different routes and middleware. This is where Flask would use decorators.</p>
<p>These two are <em>middleware layers.</em> The path <code>./client/build</code> will be served statically, and request bodies containing JSON will be parsed into proper JSON, as would happen with <code>JSON.parse()</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>app.use(express.<span style="font-weight:bold">static</span>(path.join(__dirname, <span style="color:#666;font-style:italic">&#39;client/build&#39;</span>)));
</span></span><span style="display:flex;"><span>app.use(bodyParser.json());
</span></span></code></pre></div><p>This is a dedicated <em>router.</em> We&rsquo;ll get into what it does below, but it&rsquo;s like a submodule that handles routes beginning with <code>/api/tasks</code>. When we get to it, we&rsquo;ll see that it implements CRUD operations, which will be routed under <code>/api/tasks/add</code>, <code>/api/tasks/delete/</code>, etc.</p>
<p>The third argument is a callback that returns a 401 error; it will be executed if nothing matches under <code>routeTasks</code>.</p>
<p>The callbacks take two arguments <code>req</code> and <code>res</code>, for &ldquo;request&rdquo; and &ldquo;response&rdquo; respectively. To return a response, you call a method of <code>res</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>app.use(<span style="color:#666;font-style:italic">&#39;/api/tasks&#39;</span>, routeTasks, (req, res) =&gt; res.sendStatus(401));
</span></span></code></pre></div><p>This last one is a catchall router for things that match none of the previous &mdash; it just routes the user back to <code>index.html</code>, the root page.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>app.get(<span style="color:#666;font-style:italic">&#39;*&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>  res.sendFile(path.join(__dirname + <span style="color:#666;font-style:italic">&#39;/client/build/index.html&#39;</span>));
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Finally, we start the server. <code>process.env.PORT</code> resolves to the environment variable <code>$PORT</code> if it is set.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> port = process.env.PORT || 5000;
</span></span><span style="display:flex;"><span>app.listen(port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>console.log(<span style="color:#666;font-style:italic">`listening on </span><span style="color:#666;font-style:italic">${</span>port<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic">`</span>);
</span></span></code></pre></div><h2 id="src">src/</h2>
<p>This folder contains two subfolders, <code>models/</code> and <code>routes/</code>. Each of these contains a Mongoose model/Express router for each application datatype. As it happens, there&rsquo;s only one, so we have only two files (plus the one that establishes the database connection) to discuss.</p>
<h3 id="srcdbjs">src/db.js</h3>
<p>This file is very simple; it does nothing but establish a connection to MongoDB through Mongoose.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> mongoose = require(<span style="color:#666;font-style:italic">&#39;mongoose&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>mongoose.connect(<span style="color:#666;font-style:italic">&#39;mongodb://localhost/simple-mern&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>module.exports = mongoose;
</span></span></code></pre></div><p>Note that the structure of this file means that calling <code>require('db')</code> establishes a database connection. Nice.</p>
<h3 id="srcmodelstaskjs">src/models/task.js</h3>
<p>This is a simple object model using Mongoose. There are two fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> mongoose = require(<span style="color:#666;font-style:italic">&#39;../db&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> task = <span style="font-weight:bold">new</span> mongoose.Schema({
</span></span><span style="display:flex;"><span>  title: { type: <span style="font-weight:bold;font-style:italic">String</span>, required: <span style="font-weight:bold">true</span> },
</span></span><span style="display:flex;"><span>  done: { type: <span style="font-weight:bold;font-style:italic">Boolean</span>, <span style="font-weight:bold">default</span>: <span style="font-weight:bold">false</span> }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> Task = mongoose.model(<span style="color:#666;font-style:italic">&#39;Task&#39;</span>, task);
</span></span><span style="display:flex;"><span>module.exports = Task;
</span></span></code></pre></div><h3 id="srcroutestasksjs">src/routes/tasks.js</h3>
<p>Here we find the CRUD routes for the Task model. Note the plural filename, since these routes act on a <em>collection of tasks.</em> First we import Express and our model.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> express = require(<span style="color:#666;font-style:italic">&#39;express&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> Task = require(<span style="color:#666;font-style:italic">&#39;../models/task&#39;</span>);
</span></span></code></pre></div><p>Next we set up a <code>Router</code> object. This catches the requests that come from the root Express router.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">const</span> router = express.Router();
</span></span></code></pre></div><p>Now we have the actual routes. These have the same form as the ones we saw previously.</p>
<p>This one does a search of all <code>Tasks</code> with an empty filter, which returns them all, then returns that as the JSON response.</p>
<p>Errors are caught and returned as a <code>500</code> response.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>router.get(<span style="color:#666;font-style:italic">&#39;/&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>  Task.find({})
</span></span><span style="display:flex;"><span>    .then(tasks =&gt; res.json(tasks))
</span></span><span style="display:flex;"><span>    .<span style="font-weight:bold">catch</span>(err =&gt; res.status(500).json({ error: err }));
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>The other three routes are very similar. The only thing that changes is which <code>mongoose</code> method is called; the names are self-explanatory, as is the mapping of CRUD to HTTP verbs.</p>
<p>Note the destructuring assignment used on <code>req.body</code>; this builds on the <code>body-parser</code> middleware used in <code>index.js</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>router.post(<span style="color:#666;font-style:italic">&#39;/add&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> { title } = req.body;
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> newTask = <span style="font-weight:bold">new</span> Task({ title });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  newTask.save()
</span></span><span style="display:flex;"><span>    .then(task =&gt; res.json(task))
</span></span><span style="display:flex;"><span>    .<span style="font-weight:bold">catch</span>(err =&gt; res.json(500, err));
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router.<span style="font-weight:bold">delete</span>(<span style="color:#666;font-style:italic">&#39;/delete/:id&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> id = req.params.id;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Task.findByIdAndDelete(id)
</span></span><span style="display:flex;"><span>    .then(task =&gt; res.json(task))
</span></span><span style="display:flex;"><span>    .<span style="font-weight:bold">catch</span>(err =&gt; res.json(500, err));
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>router.post(<span style="color:#666;font-style:italic">&#39;/update/:id&#39;</span>, (req, res) =&gt; {
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> { done } = req.body;
</span></span><span style="display:flex;"><span>  Task.findByIdAndUpdate(req.params.id, { done })
</span></span><span style="display:flex;"><span>    .then(task =&gt; res.json(task))
</span></span><span style="display:flex;"><span>    .<span style="font-weight:bold">catch</span>(err =&gt; res.json(500, err));
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Finally, we set this as the default export.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>module.exports = router;
</span></span></code></pre></div><p>In the next post, we&rsquo;ll discuss the React frontend.</p>

</article>

  </main>
  <footer> Made with <a href="https://github.com/sverona/hugo-semiotic">Hugo Semiotic</a> 
</footer>

    
</body>

</html>
