<!DOCTYPE html>
<html lang="en-us">

<head>
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Automating transaction imports with Actual | S. Verona Li≈°kov√°</title>
<meta name="title" content="Automating transaction imports with Actual" />
<meta name="description" content="Setting up a YNAB, sans subscription fees." />
<meta name="keywords" content="finance,python,javascript,bash,project-writeup,2022," />


<meta property="og:title" content="Automating transaction imports with Actual" />
<meta property="og:description" content="Setting up a YNAB, sans subscription fees." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sverona.dev/blog/automating-actual/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2022-08-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-08-16T00:00:00+00:00" />




<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Automating transaction imports with Actual"/>
<meta name="twitter:description" content="Setting up a YNAB, sans subscription fees."/>



<meta itemprop="name" content="Automating transaction imports with Actual">
<meta itemprop="description" content="Setting up a YNAB, sans subscription fees."><meta itemprop="datePublished" content="2022-08-16T00:00:00+00:00" />
<meta itemprop="dateModified" content="2022-08-16T00:00:00+00:00" />
<meta itemprop="wordCount" content="691">
<meta itemprop="keywords" content="finance,python,javascript,bash,project-writeup,2022," />
<meta name="referrer" content="no-referrer-when-downgrade" />

  
  <link href="https://sverona.dev/fonts/fonts.css" type="text/css" rel="stylesheet" />
  
  
  <link href="https://sverona.dev/sass/style.css" type="text/css" rel="stylesheet" />
  <link href="https://sverona.dev/sass/sidenotes.css" type="text/css" rel="stylesheet" />
  

  <script>
    // @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&dn=gpl-3.0.txt GPL-3.0

    

    document.addEventListener("DOMContentLoaded", () => {
      var els = document.getElementsByClassName("highlight");
      for (var i = 0; i < els.length; i++) {
        if (els[i].title.length) {
          var newNode = document.createElement("code");
          var textNode = document.createTextNode(els[i].title);
          newNode.appendChild(textNode);
          newNode.classList.add("highlight-title");
          var pre = els[i].querySelector('pre');
          pre.appendChild(newNode);
        }
      }
    });
    // @license-end
  </script>

</head>

<body>
  <header id="header"><a href="/" class="title" id="brand">
  <img src="/favicon.ico"> <strong>S. Verona Li≈°kov√°</strong>
</a>
<nav><ul class="horizontal-list">

<li><a href="/about">about</a></li>

</ul>
</nav>
</header>
  <main><noscript>
  <section style="background-color: #e6e8fa; margin-block: 1rem; padding: 1px 1rem; box-shadow: 2px 2px #000">
    <p>Hello, sentient being who has disabled JavaScript/is using <a href="https://www.gnu.org/software/librejs/index.html">LibreJS</a>!</p>
    <p>This site uses as little JavaScript as I can get away with, but it does require JS to:</p>
<ol>
  <li>render mathematics; for this purpose I use <a href="https://katex.org">KaTeX</a>, which is freely licensed (and partially trans-made! üè≥Ô∏è‚Äçüåà)</li>
  <li>slightly extend Hugo's <a href="https://gohugo.io/content-management/syntax-highlighting/#highlight-shortcode">highlight shortcode</a> to show filenames in code listings. (The actual syntax highlighting is done server-side.)</li>
</ol>
    <p>This site validates under LibreJS as of 6 September 2022. If you find otherwise, please contact me.</p>
  </section>
</noscript>

<header id="front-matter">
  <h1>Automating transaction imports with Actual</h1>
  <p class="subtitle"><date>16 August 2022</date></p>
  
  <ul class="horizontal-list page-tags">
      
        <li><a href="https://sverona.dev/tags/finance/">finance</a></li>
      
        <li><a href="https://sverona.dev/tags/python/">python</a></li>
      
        <li><a href="https://sverona.dev/tags/javascript/">javascript</a></li>
      
        <li><a href="https://sverona.dev/tags/bash/">bash</a></li>
      
        <li><a href="https://sverona.dev/tags/project-writeup/">project-writeup</a></li>
      
        <li><a href="https://sverona.dev/tags/2022/">2022</a></li>
      
  </ul>
  
</div>
</header>

<article>
  
  <div id="toc" class="margin-toggle margin-left">
    <h2>Table of Contents</h2>
    <nav id="TableOfContents">
  <ul>
    <li><a href="#why-actual">Why Actual?</a></li>
    <li><a href="#my-toolchain">My toolchain</a></li>
    <li><a href="#the-scripts">The scripts</a></li>
  </ul>
</nav>
  </div>
  
  <p>My fianc√©, who is a CFP, recently encouraged me to finally set up a budget. I found <a href="https://actualbudget.com/">Actual</a> to be the most appropriate client for me; I love the nice design and the very responsive devteam. So far it&rsquo;s a wonderful open-source project that I want to contribute to in the future.</p>
<p>The killer feature Actual is currently missing is inbuilt transaction import. Apparently this is in development through Plaid integration, but I can&rsquo;t find a timeline on this, and in order for me to be able to stick with a budget I need to not have to manually type in a payee, date, and amount every time I buy something. Attempts to connect to my bank via OFX all failed, because apparently individual developers don&rsquo;t use OFX anymore.</p>
<p>So I wrote it myself. My solution is not particularly elegant, but it does work for me.</p>
<h2 id="why-actual">Why Actual?</h2>
<p>As I mentioned above, Actual is <strong>open-source</strong> and <strong>cross-platform</strong> with <strong>a very pretty interface</strong> and <strong>a responsive community.</strong> Critically, it also has <strong>a fairly complete API.</strong> The only other open-source solution I was able to find was <a href="https://www.firefly-iii.org/">Firefly III</a>, which seems really nice and featureful, but I really don&rsquo;t think I&rsquo;m enough of a finance type to pick up double-entry bookkeeping &mdash; I&rsquo;m not running a business or starting a portfolio or anything, I just want to know where my money is going.</p>
<p>I eschewed <a href="https://www.youneedabudget.com/">YNAB</a> and its kin because I can&rsquo;t understand paying $15/mo for something I have the technical expertise to set up myself for nothing more than server fees. I do like the zero-based system, though &mdash; it&rsquo;s easy to understand and fits my use case. The author of Firefly III has posted <a href="https://docs.firefly-iii.org/firefly-iii/about-firefly-iii/zero-based-budgeting/">a pretty good critique of zero-based systems</a>. I&rsquo;m not wise enough to dispute it. Maybe I&rsquo;ll switch sometime in the future, but for now I believe I have my needs met.</p>
<h2 id="my-toolchain">My toolchain</h2>
<p>I have my bank account configured to send me emails for each withdrawal or deposit.<label for="sidenote-0" class="margin-toggle sidenote-number "></label><input type="checkbox" id="sidenote-0" class="margin-toggle"/><span class="sidenote ">I have to imagine that most banks will let you do this.</span> I use <a href="https://github.com/emersion/hydroxide">hydroxide</a> and good old <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/">BeautifulSoup</a> to scrape transaction data from these emails, which I dump to a JSON file.</p>
<p>Actual&rsquo;s API is written in Node, and it wasn&rsquo;t too hard to write a little script to auto-import JSON data from a file. I automated this with <code>cron</code> and hey, presto.</p>
<h2 id="the-scripts">The scripts</h2>
<p><a href="https://github.com/sverona/actual-import/blob/master/mail.py"><code>mail.py</code></a> is responsible for pulling transactions out of my email. Here is my very simple transaction class, plus a conversion to <a href="https://actualbudget.com/docs/developers/API/#transaction">Actual&rsquo;s internal JSON format</a>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>@dataclass
</span></span><span style="display:flex;"><span><span style="font-weight:bold">class</span> <span style="color:#666;font-weight:bold;font-style:italic">Transaction</span>:
</span></span><span style="display:flex;"><span>    date: <span style="font-weight:bold;font-style:italic">str</span>
</span></span><span style="display:flex;"><span>    payee: <span style="font-weight:bold;font-style:italic">str</span>
</span></span><span style="display:flex;"><span>    amount: <span style="font-weight:bold;font-style:italic">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#666;font-weight:bold;font-style:italic">convert_transaction</span>(trans: Transaction) -&gt; <span style="font-weight:bold;font-style:italic">dict</span>:
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">return</span> { <span style="color:#666;font-style:italic">&#34;date&#34;</span>: trans.date,
</span></span><span style="display:flex;"><span>             <span style="color:#666;font-style:italic">&#34;payee_name&#34;</span>: trans.payee,
</span></span><span style="display:flex;"><span>             <span style="color:#666;font-style:italic">&#34;amount&#34;</span>: trans.amount }
</span></span></code></pre></div><p>There are some bank-specific parts that aren&rsquo;t worth showing &mdash; functions <code>parse_withdrawal</code> and <code>parse_deposit</code> that take an IMAP server connection plus an email&rsquo;s IMAP index and return a <code>Transaction</code>. You&rsquo;ll need to write these yourself.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="font-weight:bold">def</span> <span style="color:#666;font-weight:bold;font-style:italic">main</span>():
</span></span><span style="display:flex;"><span>    parser = argparse.ArgumentParser()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    parser.add_argument(<span style="color:#666;font-style:italic">&#34;-o&#34;</span>, <span style="color:#666;font-style:italic">&#34;--out&#34;</span>, help=<span style="color:#666;font-style:italic">&#34;JSON file to write transactions to. If not specified, use stdout.&#34;</span>)
</span></span><span style="display:flex;"><span>    args = parser.parse_args()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    json_transactions = []
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">with</span> imaplib.IMAP4(port=1143) <span style="font-weight:bold">as</span> conn:
</span></span><span style="display:flex;"><span>        conn.login(username, bridge_password)
</span></span><span style="display:flex;"><span>        conn.select()
</span></span><span style="display:flex;"><span>        resp, withdrawal_emails = conn.search(<span style="font-weight:bold">None</span>, <span style="color:#666;font-style:italic">&#39;(SUBJECT &#34;PNC&#34;)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> resp == <span style="color:#666;font-style:italic">&#34;OK&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold;font-style:italic">print</span>(resp, withdrawal_emails)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            idxs = withdrawal_emails[0].split()
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">for</span> idx <span style="font-weight:bold">in</span> idxs:
</span></span><span style="display:flex;"><span>                transaction = parse_withdrawal(conn, idx)
</span></span><span style="display:flex;"><span>                json_transactions.append(convert_transaction(transaction))
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        resp, deposit_emails = conn.search(<span style="font-weight:bold">None</span>, <span style="color:#666;font-style:italic">&#39;(SUBJECT &#34;Deposit&#34;)&#39;</span>)
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">if</span> resp == <span style="color:#666;font-style:italic">&#34;OK&#34;</span>:
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold;font-style:italic">print</span>(resp, deposit_emails)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            idxs = deposit_emails[0].split()
</span></span><span style="display:flex;"><span>            <span style="font-weight:bold">for</span> idx <span style="font-weight:bold">in</span> idxs:
</span></span><span style="display:flex;"><span>                transaction = parse_deposit(conn, idx)
</span></span><span style="display:flex;"><span>                json_transactions.append(convert_transaction(transaction))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">if</span> args.out:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold">with</span> <span style="font-weight:bold;font-style:italic">open</span>(args.out, <span style="color:#666;font-style:italic">&#34;w&#34;</span>) <span style="font-weight:bold">as</span> outfile:
</span></span><span style="display:flex;"><span>            json.dump(json_transactions, outfile)
</span></span><span style="display:flex;"><span>    <span style="font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="font-weight:bold;font-style:italic">print</span>(json.dumps(json_transactions))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">if</span> __name__ == <span style="color:#666;font-style:italic">&#34;__main__&#34;</span>:
</span></span><span style="display:flex;"><span>    main()
</span></span></code></pre></div><p><a href="https://github.com/sverona/actual-import/blob/master/import-transactions.js"><code>import-transactions.js</code></a>, well, imports exported transactions into Actual. The main difficulty with writing this was figuring out how to call the <em>internal</em> API, since the external API is still in the midst of being moved over to a self-hosted architecture.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="font-weight:bold">await</span> actual.init({
</span></span><span style="display:flex;"><span>  config: { dataDir: path.join(dirname, <span style="color:#666;font-style:italic">&#39;user-files&#39;</span>) }
</span></span><span style="display:flex;"><span>});
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="font-weight:bold">await</span> actual.internal.send(<span style="color:#666;font-style:italic">&#39;load-budget&#39;</span>, { id: <span style="color:#666;font-style:italic">&#39;budget-uuid&#39;</span> });
</span></span><span style="display:flex;"><span><span style="font-weight:bold">const</span> accounts = <span style="font-weight:bold">await</span> actual.getAccounts();
</span></span><span style="display:flex;"><span><span style="font-weight:bold">await</span> actual.internal.send(<span style="color:#666;font-style:italic">&#39;api/accounts-get&#39;</span>).then( accounts =&gt; {
</span></span><span style="display:flex;"><span>  <span style="font-weight:bold">const</span> acctId = accounts[0].id;
</span></span><span style="display:flex;"><span>  actual.internal.send(<span style="color:#666;font-style:italic">&#39;transactions-import&#39;</span>, {accountId: acctId, transactions: data} ).then( imported =&gt; {
</span></span><span style="display:flex;"><span>    console.log(<span style="color:#666;font-style:italic">`Imported </span><span style="color:#666;font-style:italic">${</span>imported.length<span style="color:#666;font-style:italic">}</span><span style="color:#666;font-style:italic"> transactions.`</span>);
</span></span><span style="display:flex;"><span>  }).then( nothing =&gt; actual.internal.send(<span style="color:#666;font-style:italic">&#39;close-budget&#39;</span>) );
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Finally, a little shell script that ties the workflow together.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#888;font-weight:bold">#!/bin/sh
</span></span></span><span style="display:flex;"><span><span style="color:#888;font-weight:bold"></span>
</span></span><span style="display:flex;"><span><span style="color:#666;font-weight:bold;font-style:italic">filename</span>=<span style="color:#666;font-style:italic">&#34;/root/transactions/</span><span style="font-weight:bold">$(</span>date <span style="color:#666;font-style:italic">&#34;+%s&#34;</span><span style="font-weight:bold">)</span><span style="color:#666;font-style:italic">.json&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>python mail.py -o <span style="color:#666;font-weight:bold;font-style:italic">$filename</span>
</span></span><span style="display:flex;"><span>node import-transactions.js <span style="color:#666;font-weight:bold;font-style:italic">$filename</span>
</span></span></code></pre></div><p>I hope all this is helpful to someone. Happy hunting!</p>

</article>

  </main>
  <footer></footer>

    
</body>

</html>
